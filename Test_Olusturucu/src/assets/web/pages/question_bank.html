{% extends "base.html" %}

{% block title %}Soru Bankası - TestGen Pro{% endblock %}

{% block head %}
<style>
    .animate-bounce-in {
        animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes bounceIn {
        0% {
            opacity: 0;
            transform: translate(-50%, 20px);
        }

        100% {
            opacity: 1;
            transform: translate(-50%, 0);
        }
    }
</style>
{% endblock %}

{% block content %}
<header
    class="h-16 border-b border-solid border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md px-10 py-3 sticky top-0 z-40 flex items-center justify-between">
    <div class="flex items-center gap-8">
        <label class="flex flex-col min-w-40 !h-10 max-w-64">
            <div class="flex w-full flex-1 items-stretch rounded-lg h-full bg-slate-100 dark:bg-slate-800">
                <div class="text-slate-500 dark:text-slate-400 flex items-center justify-center pl-4">
                    <span class="material-symbols-outlined text-[20px]">search</span>
                </div>
                <input id="search-input" oninput="handleSearch(this.value)"
                    class="form-input flex w-full min-w-0 flex-1 border-none bg-transparent focus:ring-0 text-slate-900 dark:text-white px-4 pl-2 text-base"
                    placeholder="Soru ara..." value="" />
            </div>
        </label>
    </div>
</header>
<main class="flex flex-1 justify-center py-8">
    <div class="layout-content-container flex flex-col max-w-[1200px] flex-1 px-4 md:px-10">
        <div class="flex flex-wrap items-end justify-between gap-4 mb-6">
            <div class="flex min-w-72 flex-col gap-2">
                <p class="text-slate-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">Soru
                    Bankası</p>
                <p id="question-count-text"
                    class="text-slate-600 dark:text-slate-400 text-base font-normal leading-normal">Sorular
                    yükleniyor...</p>
            </div>
            <div class="flex gap-3">
                <button onclick="navigateTo('pdf_upload.html')"
                    class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-11 px-5 bg-primary text-white text-sm font-bold hover:bg-primary/90 transition-all shadow-lg shadow-primary/20">
                    <span class="material-symbols-outlined mr-2">upload_file</span>
                    <span class="truncate">PDF Yükle</span>
                </button>
            </div>
        </div>

        <div
            class="flex gap-3 mb-6 flex-wrap pr-4 bg-white dark:bg-slate-900 p-3 rounded-xl border border-slate-200 dark:border-slate-800">
            <div onclick="filterSubject('All', this)"
                class="subject-filter-btn flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-primary text-white px-5 cursor-pointer shadow-sm">
                <p class="text-sm font-semibold leading-normal">Tüm Sorular</p>
            </div>
            <div onclick="filterSubject('Matematik', this)"
                class="subject-filter-btn flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 px-5 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors border border-slate-200 dark:border-slate-700">
                <p class="text-sm font-medium leading-normal">Matematik</p>
            </div>
            <div onclick="filterSubject('Fizik', this)"
                class="subject-filter-btn flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 px-5 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors border border-slate-200 dark:border-slate-700">
                <p class="text-sm font-medium leading-normal">Fizik</p>
            </div>
            <div onclick="filterSubject('Türkçe', this)"
                class="subject-filter-btn flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 px-5 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors border border-slate-200 dark:border-slate-700">
                <p class="text-sm font-medium leading-normal">Türkçe</p>
            </div>
            <div onclick="filterSubject('Kimya', this)"
                class="subject-filter-btn flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 px-5 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors border border-slate-200 dark:border-slate-700">
                <p class="text-sm font-medium leading-normal">Kimya</p>
            </div>
            <div onclick="filterSubject('Biyoloji', this)"
                class="subject-filter-btn flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 px-5 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors border border-slate-200 dark:border-slate-700">
                <p class="text-sm font-medium leading-normal">Biyoloji</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="questions-container">
            <!-- Loading State -->
            <div class="col-span-full flex flex-col items-center justify-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                <p class="mt-4 text-slate-500">Sorular yükleniyor...</p>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script src="/static/js/api.js"></script>
<script>
    let selectedQuestions = new Set();
    let ALL_QUESTIONS = [];
    let FILTERED_QUESTIONS = [];
    let currentSubject = 'All';
    let searchQuery = '';

    function renderQuestions(questions) {
        const container = document.getElementById('questions-container');
        container.innerHTML = '';

        const countSpan = document.getElementById('question-count-text');
        if (countSpan) countSpan.innerText = questions.length + " soru bulundu.";

        if (questions.length === 0) {
            container.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center p-12 text-center text-slate-400">
                    <span class="material-symbols-outlined text-6xl mb-4">inbox</span>
                    <p class="text-lg">Kriterlere uygun soru bulunamadı.</p>
                </div>`;
            return;
        }

        questions.forEach(q => {
            const hasImage = q.image && q.image.length > 0;
            const isSelected = selectedQuestions.has(String(q.id));
            const borderColor = isSelected ? 'border-primary ring-2 ring-primary' : 'border-slate-200 dark:border-slate-800';

            let colorMap = {
                'Matematik': 'primary',
                'Fizik': 'amber-500',
                'Türkçe': 'indigo-500',
                'Kimya': 'emerald-500',
                'Biyoloji': 'rose-500'
            };
            let subjectColor = colorMap[q.subject] || 'slate-500';

            let diffColorMap = {
                'Zor': 'rose',
                'Orta': 'orange',
                'Kolay': 'emerald'
            };
            let diffColor = diffColorMap[q.difficulty] || 'slate';

            let mediaHtml = '';
            if (hasImage) {
                mediaHtml = `
                <div class="relative w-full bg-slate-100 dark:bg-slate-800 aspect-[16/10] flex items-center justify-center overflow-hidden">
                    <div class="w-full h-full bg-center bg-no-repeat bg-contain p-4 transition-transform group-hover:scale-105" 
                         style="background-image: url('${q.image}');"></div>
                    <div class="absolute top-3 left-3">
                        <span class="bg-${subjectColor} text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider">${q.subject}</span>
                    </div>
                </div>`;
            } else {
                mediaHtml = `
                <div class="relative w-full bg-slate-100 dark:bg-slate-800 aspect-[16/10] flex items-center justify-center overflow-hidden">
                    <div class="flex flex-col items-center justify-center p-8 text-center text-slate-400 dark:text-slate-500">
                        <span class="material-symbols-outlined text-4xl mb-2">text_fields</span>
                        <p class="text-xs">Görsel yok</p>
                    </div>
                    <div class="absolute top-3 left-3">
                        <span class="bg-${subjectColor} text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider">${q.subject}</span>
                    </div>
                </div>`;
            }

            const checkIcon = isSelected ?
                `<div class="w-6 h-6 rounded bg-primary border border-primary flex items-center justify-center shadow-sm">
                    <span class="material-symbols-outlined text-white text-sm" style="width:auto;height:auto">check</span>
                 </div>` :
                `<div class="w-6 h-6 rounded bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 flex items-center justify-center shadow-sm opacity-0 group-hover:opacity-100 transition-opacity"></div>`;

            const card = `
            <div class="group relative flex flex-col bg-white dark:bg-slate-900 rounded-xl overflow-hidden border ${borderColor} hover:shadow-xl hover:shadow-primary/5 transition-all cursor-pointer" onclick="toggleSelection('${q.id}')">
                
                <div class="absolute top-3 right-3 z-10">
                    ${checkIcon}
                </div>

                ${mediaHtml}
                <div class="p-5 flex flex-col flex-1">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-slate-900 dark:text-white text-base font-bold leading-tight">Soru #${q.id}</h3>
                        <span class="text-[11px] text-slate-400 font-medium">${q.grade_level || ''}</span>
                    </div>
                    <p class="text-slate-600 dark:text-slate-400 text-sm font-normal leading-relaxed mb-4 flex-1 line-clamp-3">
                        ${q.text || 'İçerik metni bulunamadı.'}
                    </p>
                    <div class="flex items-center justify-between pt-4 border-t border-slate-100 dark:border-slate-800">
                        <div class="flex gap-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-${diffColor}-100 text-${diffColor}-700 dark:bg-${diffColor}-900/30 dark:text-${diffColor}-400">${q.difficulty}</span>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="event.stopPropagation(); handleDelete('${q.id}')" class="p-2 text-slate-400 hover:text-rose-500 transition-colors rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">
                                <span class="material-symbols-outlined text-lg">delete</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            container.innerHTML += card;
        });

        updateSelectionUI();
    }

    function toggleSelection(id) {
        if (selectedQuestions.has(String(id))) {
            selectedQuestions.delete(String(id));
        } else {
            selectedQuestions.add(String(id));
        }
        renderQuestions(FILTERED_QUESTIONS);
    }

    function filterSubject(subject, btn) {
        currentSubject = subject;
        document.querySelectorAll('.subject-filter-btn').forEach(b => {
            b.className = "subject-filter-btn flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 px-5 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors border border-slate-200 dark:border-slate-700";
        });
        btn.className = "subject-filter-btn flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-primary text-white px-5 cursor-pointer shadow-sm";
        applyFilters();
    }

    function handleSearch(val) {
        searchQuery = val.toLowerCase();
        applyFilters();
    }

    function applyFilters() {
        FILTERED_QUESTIONS = ALL_QUESTIONS.filter(q => {
            const matchesSubject = currentSubject === 'All' || q.subject === currentSubject;
            const matchesSearch = q.text.toLowerCase().includes(searchQuery) || String(q.id).includes(searchQuery);
            return matchesSubject && matchesSearch;
        });
        renderQuestions(FILTERED_QUESTIONS);
    }

    function updateSelectionUI() {
        let bar = document.getElementById('selection-bar');
        if (selectedQuestions.size > 0) {
            if (!bar) {
                bar = document.createElement('div');
                bar.id = 'selection-bar';
                bar.className = "fixed bottom-10 left-[calc(50%+128px)] -translate-x-1/2 bg-white dark:bg-slate-900 shadow-2xl rounded-2xl border border-slate-200 dark:border-slate-700 px-8 py-3 flex items-center gap-8 z-[100] ring-1 ring-slate-950/5 animate-bounce-in";
                bar.innerHTML = `
                    <div class="flex items-center gap-3 pr-8 border-r border-slate-200 dark:border-slate-800">
                        <span class="flex h-6 w-6 items-center justify-center rounded-full bg-primary text-[10px] font-bold text-white"><span id="sel-count">0</span></span>
                        <span class="text-sm font-semibold text-slate-900 dark:text-white">Soru Seçildi</span>
                    </div>
                    <div class="flex items-center gap-6">
                        <div onclick="handleGenerateTest()" class="flex flex-col items-center gap-1 cursor-pointer group">
                            <div class="rounded-full bg-slate-100 dark:bg-slate-800 p-2 group-hover:bg-primary/10 group-hover:text-primary transition-all">
                                <span class="material-symbols-outlined text-[20px]" style="width:auto;height:auto">add_circle</span>
                            </div>
                            <p class="text-slate-600 dark:text-slate-400 text-[11px] font-medium group-hover:text-primary">PDF Oluştur</p>
                        </div>
                        <div onclick="clearSelection()" class="flex flex-col items-center gap-1 cursor-pointer group">
                            <div class="rounded-full bg-rose-50 dark:bg-rose-900/20 p-2 group-hover:bg-rose-100 group-hover:text-rose-600 transition-all">
                                <span class="material-symbols-outlined text-[20px] text-rose-500" style="width:auto;height:auto">cancel</span>
                            </div>
                            <p class="text-rose-600 dark:text-rose-400 text-[11px] font-medium">İptal</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(bar);
            }
            document.getElementById('sel-count').innerText = selectedQuestions.size;
        } else {
            if (bar) bar.remove();
        }
    }

    function clearSelection() {
        selectedQuestions.clear();
        renderQuestions(FILTERED_QUESTIONS);
    }

    async function handleGenerateTest() {
        const title = prompt("Test Başlığı Giriniz:", "Yeni Test");
        if (!title) return;
        try {
            const result = await generateTest(title, Array.from(selectedQuestions));
            if (result.status === "success") {
                window.open(result.url, '_blank');
                clearSelection();
            }
        } catch (e) {
            alert("Test oluşturulamadı: " + e.message);
        }
    }

    async function loadQuestions() {
        const data = await fetchQuestions();
        ALL_QUESTIONS = data;
        FILTERED_QUESTIONS = data;
        renderQuestions(data);
    }

    async function handleDelete(id) {
        if (confirm('Bu soruyu silmek istediğinize emin misiniz?')) {
            const success = await deleteQuestion(id);
            if (success) { loadQuestions(); }
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        loadQuestions();
    });
</script>
{% endblock %}